<div class="card panel-intro">
    <div class="card-header">
        <div class="panel-lead"><em>报工管理</em> 管理生产报工记录</div>
    </div>
    <div class="card-body">
        <div id="toolbar" class="toolbar mb-2">
            <a href="javascript:;" class="btn btn-primary btn-refresh" title="刷新"><i class="fas fa-sync-alt"></i> 刷新</a>
            <a href="{$config.moduleurl}/mes/report/add" class="btn btn-success btn-add" title="添加"><i class="fas fa-plus"></i> 添加报工</a>
            <a href="javascript:;" class="btn btn-warning btn-audit btn-disabled disabled" title="审核"><i class="fas fa-check-circle"></i> 审核</a>
            <a href="javascript:;" class="btn btn-success btn-edit btn-disabled disabled" title="编辑"><i class="fas fa-edit"></i> 编辑</a>
            <a href="javascript:;" class="btn btn-danger btn-del btn-disabled disabled" title="删除"><i class="fas fa-trash-alt"></i> 删除</a>
        </div>
        <table id="table" class="table table-striped table-bordered table-hover" width="100%"></table>
    </div>
</div>

<script>
$(function() {
    var base = (typeof Config !== 'undefined' && Config.moduleurl) ? Config.moduleurl : '';
    var table = $('#table');
    
    if (typeof table.bootstrapTable !== 'function' || table.data('bootstrap.table')) {
        return;
    }
    
    table.bootstrapTable({
        url: base + '/mes/report/index',
        pk: 'id',
        sortName: 'id',
        sortOrder: 'desc',
        columns: [
            {field: 'id', title: 'ID', width: 80, sortable: true, checkbox: true},
            {field: 'allocation.order.order_no', title: '订单号', align: 'left'},
            {field: 'allocation.model.product.name', title: '产品', align: 'left'},
            {field: 'allocation.process.name', title: '工序', align: 'left'},
            {field: 'work_type', title: '工作类型', width: 100, formatter: function(value) {
                return value == 'piece' ? '<span class="badge badge-primary">计件</span>' : '<span class="badge badge-info">计时</span>';
            }},
            {field: 'quantity', title: '数量', width: 100, align: 'right', formatter: function(value, row) {
                return row.work_type == 'piece' ? value : '-';
            }},
            {field: 'work_hours', title: '工时', width: 100, align: 'right', formatter: function(value, row) {
                return row.work_type == 'time' ? parseFloat(value).toFixed(2) : '-';
            }},
            {field: 'wage', title: '工资', width: 120, align: 'right', formatter: function(value) {
                return '<span class="text-danger font-weight-bold">¥' + parseFloat(value || 0).toFixed(2) + '</span>';
            }},
            {field: 'status', title: '状态', width: 100, formatter: function(value) {
                var statusMap = {0: '待审核', 1: '已通过', 2: '已拒绝'};
                var classMap = {0: 'warning', 1: 'success', 2: 'danger'};
                return '<span class="badge badge-' + (classMap[value] || 'secondary') + '">' + (statusMap[value] || '未知') + '</span>';
            }},
            {field: 'quality_status', title: '质量', width: 100, formatter: function(value) {
                return value == 1 ? '<span class="badge badge-success">合格</span>' : '<span class="badge badge-danger">不合格</span>';
            }},
            {field: 'create_time', title: '报工时间', width: 180, formatter: function(value) {
                return value ? new Date(value * 1000).toLocaleString('zh-CN') : '';
            }},
            {field: 'operate', title: '操作', width: 120, events: {
                'click .btn-edit': function(e, value, row) {
                    location.href = base + '/mes/report/edit?ids=' + row.id;
                },
                'click .btn-del': function(e, value, row) {
                    if (confirm('确定要删除吗？')) {
                        $.post(base + '/mes/report/del', {ids: row.id}, function(r) {
                            if (r.code == 1) {
                                table.bootstrapTable('refresh');
                                alert(r.msg || '删除成功');
                            } else {
                                alert(r.msg || '删除失败');
                            }
                        }, 'json');
                    }
                }
            }, formatter: function(value, row) {
                return '<a href="' + base + '/mes/report/edit?ids=' + row.id + '" class="btn btn-xs btn-success btn-edit">编辑</a> ' +
                       '<a href="javascript:;" class="btn btn-xs btn-danger btn-del">删除</a>';
            }}
        ]
    });
    
    // 刷新
    $(document).off('click', '#toolbar .btn-refresh').on('click', '#toolbar .btn-refresh', function() {
        table.bootstrapTable('refresh');
    });
    
    // 审核按钮
    $(document).off('click', '#toolbar .btn-audit').on('click', '#toolbar .btn-audit', function() {
        var rows = table.bootstrapTable('getSelections');
        if (rows.length == 0) {
            alert('请选择要审核的记录');
            return;
        }
        var ids = rows.map(function(r) { return r.id; });
        location.href = base + '/mes/report/audit_page?ids=' + ids.join(',');
    });
    
    // 编辑按钮
    $(document).off('click', '#toolbar .btn-edit').on('click', '#toolbar .btn-edit', function() {
        var rows = table.bootstrapTable('getSelections');
        if (rows.length != 1) {
            alert('请选择一条记录');
            return;
        }
        location.href = base + '/mes/report/edit?ids=' + rows[0].id;
    });
    
    // 删除按钮
    $(document).off('click', '#toolbar .btn-del').on('click', '#toolbar .btn-del', function() {
        var rows = table.bootstrapTable('getSelections');
        if (rows.length == 0) {
            alert('请选择要删除的记录');
            return;
        }
        if (!confirm('确定要删除选中的 ' + rows.length + ' 条记录吗？')) {
            return;
        }
        var ids = rows.map(function(r) { return r.id; });
        $.post(base + '/mes/report/del', {ids: ids.join(',')}, function(r) {
            if (r.code == 1) {
                table.bootstrapTable('refresh');
                alert(r.msg || '删除成功');
            } else {
                alert(r.msg || '删除失败');
            }
        }, 'json');
    });
    
    // 表格行选择
    table.on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table', function() {
        var rows = table.bootstrapTable('getSelections');
        if (rows.length > 0) {
            $('.btn-edit, .btn-del, .btn-audit').removeClass('disabled btn-disabled');
        } else {
            $('.btn-edit, .btn-del, .btn-audit').addClass('disabled btn-disabled');
        }
    });
});
</script>
