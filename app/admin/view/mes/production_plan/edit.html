<div class="card card-outline card-primary">
    <div class="card-header">
        <h3 class="card-title">编辑生产计划</h3>
    </div>
    <div class="card-body">
        <form id="form-edit" method="post" class="form-horizontal">
            <input type="hidden" name="row[id]" value="{$data.id}">
            <div class="form-group row">
                <label class="col-sm-2 col-form-label">订单 <span class="text-danger">*</span></label>
                <div class="col-sm-6">
                    <select name="row[order_id]" class="form-control" id="order_id" required>
                        <option value="">请选择订单</option>
                        {volist name="orderList" id="vo"}
                        <option value="{$key}" {eq name="key" value="$data.order_id"}selected{/eq}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-2 col-form-label">计划名称 <span class="text-danger">*</span></label>
                <div class="col-sm-6">
                    <input type="text" name="row[plan_name]" class="form-control" value="{$data.plan_name}" placeholder="请输入计划名称" required>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-2 col-form-label">计划数量 <span class="text-danger">*</span></label>
                <div class="col-sm-6">
                    <input type="number" name="row[total_quantity]" class="form-control" min="1" value="{$data.total_quantity}" placeholder="请输入计划数量" required>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-2 col-form-label">计划开始时间</label>
                <div class="col-sm-6">
                    <input type="datetime-local" name="row[planned_start_time]" class="form-control" value="{if condition='$data.planned_start_time'}{$data.planned_start_time|date='Y-m-d\TH:i',###}{/if}">
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-2 col-form-label">计划结束时间</label>
                <div class="col-sm-6">
                    <input type="datetime-local" name="row[planned_end_time]" class="form-control" value="{if condition='$data.planned_end_time'}{$data.planned_end_time|date='Y-m-d\TH:i',###}{/if}">
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-2 col-form-label">状态</label>
                <div class="col-sm-6">
                    <select name="row[status]" class="form-control">
                        <option value="0" {eq name="data.status" value="0"}selected{/eq}>待开始</option>
                        <option value="1" {eq name="data.status" value="1"}selected{/eq}>进行中</option>
                        <option value="2" {eq name="data.status" value="2"}selected{/eq}>已完成</option>
                        <option value="3" {eq name="data.status" value="3"}selected{/eq}>已暂停</option>
                    </select>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-2 col-form-label">备注</label>
                <div class="col-sm-6">
                    <textarea name="row[remark]" class="form-control" rows="3" placeholder="请输入备注">{$data.remark}</textarea>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-sm-8 offset-sm-2">
                    <button type="submit" class="btn btn-primary">保存</button>
                    <a href="{$config.moduleurl}/mes/production_plan/index" class="btn btn-default">返回</a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    function initForm() {
        if (typeof jQuery === 'undefined') {
            setTimeout(initForm, 50);
            return;
        }
        var $ = jQuery;
        var base = (typeof Config !== 'undefined' && Config.moduleurl) ? Config.moduleurl : '';
        $('#form-edit').attr('action', base + '/mes/production_plan/edit');
        $('#form-edit').on('submit', function (e) {
            e.preventDefault();
            // 转换datetime-local为时间戳
            var startTime = $('input[name="row[planned_start_time]"]').val();
            var endTime = $('input[name="row[planned_end_time]"]').val();
            if (startTime) {
                $('input[name="row[planned_start_time]"]').val(Math.floor(new Date(startTime).getTime() / 1000));
            }
            if (endTime) {
                $('input[name="row[planned_end_time]"]').val(Math.floor(new Date(endTime).getTime() / 1000));
            }
            $.post($(this).attr('action') + '?id=' + $('input[name="row[id]"]').val(), $(this).serialize(), function (r) {
                if (r && r.msg) {
                    alert(r.msg);
                }
                if (r && r.code === 1) {
                    location.href = base + '/mes/production_plan/index';
                }
            }, 'json').fail(function(xhr) {
                try {
                    var r = JSON.parse(xhr.responseText);
                    alert(r.msg || '操作失败');
                } catch(e) {
                    alert('操作失败');
                }
            });
        });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initForm);
    } else {
        initForm();
    }
})();
</script>
